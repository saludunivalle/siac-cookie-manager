const puppeteer = require('puppeteer');
const { google } = require('googleapis');

// Configuraci√≥n robusta
const CONFIG = {
    URL: 'https://proxse26.univalle.edu.co/asignacion/vin_asignacion.php3',
    CEDULA_TEST: '1112966620',
    TIMEOUT_LONG: 30000,
    TIMEOUT_SHORT: 10000,
    RETRY_ATTEMPTS: 3,
    WAIT_BETWEEN_RETRIES: 3000
};

// M√∫ltiples selectores posibles
const CEDULA_SELECTORS = [
    'input[name="cedula"]',
    'input[type="text"]',
    'input[placeholder*="cedula" i]',
    'input[placeholder*="documento" i]',
    'input.cedula',
    'input#cedula',
    'form input[type="text"]:first-of-type',
    'form input:first-of-type',
    'input'
];

const SUBMIT_SELECTORS = [
    'img[src*="imprimir_.gif"]',
    'img[alt*="Imprimir" i]',
    'input[type="submit"][value*="Imprimir" i]',
    'input[type="submit"]',
    'button[type="submit"]',
    'form button',
    'input[type="button"]'
];

async function extractCookies() {
    console.log('üöÄ Iniciando extracci√≥n de cookies...');
    
    const browser = await puppeteer.launch({
        headless: "new",
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox',
            '--disable-dev-shm-usage',
            '--disable-accelerated-2d-canvas',
            '--no-first-run',
            '--no-zygote',
            '--disable-gpu',
            '--disable-web-security',
            '--disable-features=VizDisplayCompositor',
            '--disable-blink-features=AutomationControlled',
            '--disable-extensions'
        ]
    });

    try {
        const page = await browser.newPage();
        
        // üé≠ ANTI-DETECCI√ìN: Simular navegador real
        await page.setUserAgent('Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36');
        await page.setViewport({ width: 1366, height: 768 });
        
        // Eliminar indicadores de automatizaci√≥n
        await page.evaluateOnNewDocument(() => {
            // Eliminar webdriver property
            delete navigator.webdriver;
            
            // Simular plugins
            Object.defineProperty(navigator, 'plugins', {
                get: () => [1, 2, 3, 4, 5],
            });
            
            // Simular languages
            Object.defineProperty(navigator, 'languages', {
                get: () => ['es-ES', 'es', 'en'],
            });
        });
        
        // Logs para debugging
        page.on('console', msg => console.log('üñ•Ô∏è Browser:', msg.text()));
        page.on('pageerror', error => console.log('‚ùå Page Error:', error.message));
        
                 // üåê NAVEGACI√ìN CON REINTENTOS
         let navigationSuccess = false;
         for (let attempt = 1; attempt <= CONFIG.RETRY_ATTEMPTS; attempt++) {
             try {
                 console.log(`üìÑ Intento ${attempt}: Navegando a la p√°gina...`);
                 
                 const response = await page.goto(CONFIG.URL, {
                     waitUntil: ['networkidle2', 'domcontentloaded'],
                     timeout: CONFIG.TIMEOUT_LONG
                 });

                 console.log(`‚úÖ Respuesta: ${response.status()}`);
                 
                 if (response.status() === 200) {
                     // Esperar JavaScript adicional y frames
                     await page.waitForTimeout(8000);
                     navigationSuccess = true;
                     break;
                 }
             } catch (error) {
                 console.log(`‚ö†Ô∏è Intento ${attempt} fall√≥:`, error.message);
                 if (attempt < CONFIG.RETRY_ATTEMPTS) {
                     await page.waitForTimeout(CONFIG.WAIT_BETWEEN_RETRIES);
                 }
             }
         }

         if (!navigationSuccess) {
             throw new Error('No se pudo cargar la p√°gina despu√©s de varios intentos');
         }

         // üñºÔ∏è DETECTAR Y MANEJAR FRAMES
         console.log('üîç Analizando estructura de frames...');
         const frames = page.frames();
         console.log(`üìã Total frames encontrados: ${frames.length}`);
         
         let targetFrame = page.mainFrame(); // Por defecto, usar frame principal
         
         // Buscar frame que contenga el formulario
         for (const frame of frames) {
             const frameUrl = frame.url();
             console.log(`   üñºÔ∏è Frame: ${frameUrl}`);
             
             if (frameUrl.includes('vin_docente.php3') || frameUrl.includes('asignacion')) {
                 console.log(`‚úÖ Frame objetivo encontrado: ${frameUrl}`);
                 targetFrame = frame;
                 break;
             }
         }
         
         console.log(`üéØ Trabajando en frame: ${targetFrame.url()}`)

                 // üîç AN√ÅLISIS DEL FRAME OBJETIVO
         console.log('üîç Analizando contenido del frame...');
         
         const frameInfo = await targetFrame.evaluate(() => {
             const inputs = Array.from(document.querySelectorAll('input')).map(input => ({
                 type: input.type,
                 name: input.name,
                 id: input.id,
                 placeholder: input.placeholder,
                 visible: window.getComputedStyle(input).display !== 'none'
             }));
             
             const forms = Array.from(document.querySelectorAll('form')).map(form => ({
                 action: form.action,
                 method: form.method,
                 inputCount: form.querySelectorAll('input').length
             }));
             
             return {
                 title: document.title,
                 url: window.location.href,
                 inputs: inputs,
                 forms: forms,
                 bodyText: document.body.innerText.substring(0, 200)
             };
         });

         console.log('üìã Frame analizado:', JSON.stringify(frameInfo, null, 2));

                 // üìù BUSCAR CAMPO DE C√âDULA EN EL FRAME
         console.log('üîç Buscando campo de c√©dula en el frame...');
         let cedulaSelector = null;
         
         for (const selector of CEDULA_SELECTORS) {
             try {
                 await targetFrame.waitForSelector(selector, { timeout: 3000, visible: true });
                 const element = await targetFrame.$(selector);
                 if (element) {
                     console.log(`‚úÖ Campo de c√©dula encontrado con: ${selector}`);
                     cedulaSelector = selector;
                     break;
                 }
             } catch (e) {
                 console.log(`   ‚ùå Selector ${selector} fall√≥`);
                 continue;
             }
         }

         if (!cedulaSelector) {
             // Si no encuentra input, mostrar todos los disponibles
             const allInputs = await targetFrame.evaluate(() => {
                 return Array.from(document.querySelectorAll('input, textarea')).map(el => ({
                     tag: el.tagName,
                     type: el.type,
                     name: el.name,
                     id: el.id,
                     className: el.className
                 }));
             });
             console.log('üìã Todos los inputs disponibles en frame:', allInputs);
             throw new Error('No se encontr√≥ campo de c√©dula con ning√∫n selector');
         }

                 // ‚úèÔ∏è LLENAR C√âDULA EN EL FRAME
         console.log('‚úèÔ∏è Llenando campo de c√©dula en el frame...');
         await targetFrame.type(cedulaSelector, CONFIG.CEDULA_TEST, { delay: 100 });
         await page.waitForTimeout(1000); // Pausa para procesar

         // üöÄ ENVIAR FORMULARIO CON JAVASCRIPT (SOLUCI√ìN ANTI-FRAME)
         console.log('üöÄ Enviando formulario directamente con JavaScript...');
         
         try {
             // M√©todo 1: Buscar formulario y enviarlo
             const formSubmitted = await targetFrame.evaluate((cedulaSelector) => {
                 const cedulaInput = document.querySelector(cedulaSelector);
                 if (cedulaInput && cedulaInput.form) {
                     console.log('üìã Formulario encontrado, enviando...');
                     cedulaInput.form.submit();
                     return true;
                 }
                 return false;
             }, cedulaSelector);

             if (formSubmitted) {
                 console.log('‚úÖ Formulario enviado exitosamente');
                 
                 // Esperar navegaci√≥n despu√©s del env√≠o
                 try {
                     await page.waitForNavigation({ 
                         waitUntil: 'networkidle2', 
                         timeout: CONFIG.TIMEOUT_SHORT 
                     });
                     console.log('‚úÖ Navegaci√≥n completada');
                 } catch (navError) {
                     console.log('‚ö†Ô∏è No hubo navegaci√≥n, continuando...');
                 }
             } else {
                 // M√©todo 2: Buscar bot√≥n de env√≠o y hacer clic con JavaScript
                 console.log('‚ö†Ô∏è No se encontr√≥ formulario, buscando bot√≥n...');
                 
                 for (const selector of SUBMIT_SELECTORS) {
                     try {
                         const clicked = await targetFrame.evaluate((buttonSelector) => {
                             const button = document.querySelector(buttonSelector);
                             if (button) {
                                 button.click();
                                 return true;
                             }
                             return false;
                         }, selector);
                         
                         if (clicked) {
                             console.log(`‚úÖ Bot√≥n clickeado con JavaScript: ${selector}`);
                             break;
                         }
                     } catch (e) {
                         continue;
                     }
                 }
             }
             
             // Esperar procesamiento
             await page.waitForTimeout(5000);
             
         } catch (submitError) {
             console.log('‚ùå Error al enviar formulario:', submitError.message);
             throw new Error(`No se pudo enviar el formulario: ${submitError.message}`);
         }

        // üç™ EXTRAER COOKIES
        console.log('üç™ Extrayendo cookies...');
        const cookies = await page.cookies();
        
        console.log(`üìã Total cookies encontradas: ${cookies.length}`);
        cookies.forEach(cookie => {
            console.log(`   ${cookie.name}: ${cookie.value.substring(0, 15)}...`);
        });
        
        const phpsessid = cookies.find(cookie => cookie.name === 'PHPSESSID')?.value;
        const asigacad = cookies.find(cookie => cookie.name === 'asigacad')?.value;

        if (!phpsessid && !asigacad) {
            console.log('‚ö†Ô∏è No se encontraron cookies espec√≠ficas, pero extracci√≥n continu√≥');
            console.log('üìã Cookies disponibles:', cookies.map(c => c.name));
            
            // Buscar cookies similares
            const similarCookies = cookies.filter(cookie => 
                cookie.name.toLowerCase().includes('sess') || 
                cookie.name.toLowerCase().includes('asig') ||
                cookie.name.toLowerCase().includes('php')
            );
            
            if (similarCookies.length > 0) {
                console.log('üîç Cookies similares encontradas:', similarCookies.map(c => c.name));
            }
        }

        const result = { phpsessid, asigacad };
        
        if (phpsessid || asigacad) {
            console.log('‚úÖ Cookies extra√≠das exitosamente');
            if (phpsessid) console.log(`PHPSESSID: ${phpsessid.substring(0, 10)}...`);
            if (asigacad) console.log(`asigacad: ${asigacad.substring(0, 10)}...`);
            
            // Actualizar Google Sheets
            await updateGoogleSheets(phpsessid, asigacad);
        } else {
            console.log('‚ö†Ô∏è Cookies objetivo no encontradas, pero proceso completado');
        }

        return result;

    } catch (error) {
        console.error('‚ùå Error durante la extracci√≥n:', error);
        throw error;
    } finally {
        await browser.close();
    }
}

async function updateGoogleSheets(phpsessid, asigacad) {
    try {
        console.log('üìä Actualizando Google Sheets...');
        
        // Configurar autenticaci√≥n con service account
        const serviceAccountKey = JSON.parse(process.env.GOOGLE_SERVICE_ACCOUNT_KEY);
        const auth = new google.auth.GoogleAuth({
            credentials: serviceAccountKey,
            scopes: ['https://www.googleapis.com/auth/spreadsheets']
        });

        const sheets = google.sheets({ version: 'v4', auth });
        const spreadsheetId = process.env.GOOGLE_SHEETS_ID;

        // Preparar datos
        const timestamp = new Date().toISOString();
        const values = [[timestamp, phpsessid, asigacad]];

        // Verificar si existe una hoja llamada 'Siac Cookies', si no la crea
        const sheetName = 'Siac Cookies';
        
        try {
            await sheets.spreadsheets.values.get({
                spreadsheetId,
                range: `${sheetName}!A1:C1`
            });
        } catch (error) {
            if (error.code === 400) {
                // La hoja no existe, crearla
                await sheets.spreadsheets.batchUpdate({
                    spreadsheetId,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: {
                                    title: sheetName
                                }
                            }
                        }]
                    }
                });
                
                // Agregar encabezados
                await sheets.spreadsheets.values.update({
                    spreadsheetId,
                    range: `${sheetName}!A1:C1`,
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['timestamp', 'PHPSESSID', 'asigacad']]
                    }
                });
            }
        }

        // Actualizar la fila 2 con los nuevos datos (sobrescribir datos anteriores)
        await sheets.spreadsheets.values.update({
            spreadsheetId,
            range: `${sheetName}!A2:C2`,
            valueInputOption: 'RAW',
            resource: { values }
        });

        console.log('‚úÖ Google Sheets actualizado exitosamente');

    } catch (error) {
        console.error('‚ùå Error actualizando Google Sheets:', error);
        throw error;
    }
}

// Ejecutar si es llamado directamente
if (require.main === module) {
    extractCookies()
        .then(cookies => {
            console.log('üéâ Proceso completado exitosamente');
            process.exit(0);
        })
        .catch(error => {
            console.error('üí• Proceso fall√≥:', error);
            process.exit(1);
        });
}

module.exports = { extractCookies }; 