name: ğŸª ExtracciÃ³n AutomÃ¡tica de Cookies Univalle

on:
  schedule:
    # Todos los dÃ­as a las 11:00 PM UTC (6:00 PM Colombia)
    - cron: '0 23 * * *'
  
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Activar modo debug detallado'
        required: false
        default: false
        type: boolean

jobs:
  extract-cookies:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout de seguridad
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Instalar dependencias
      run: |
        npm install
        # Instalar Chromium para GitHub Actions
        npx puppeteer browsers install chrome

    - name: ğŸ” Verificar configuraciÃ³n
      run: |
        echo "ğŸ”§ Verificando variables de entorno..."
        echo "GOOGLE_SHEETS_ID configurado: ${{ secrets.GOOGLE_SHEETS_ID != '' }}"
        echo "SERVICE_ACCOUNT configurado: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY != '' }}"
        echo "Modo debug: ${{ github.event.inputs.debug_mode }}"

    - name: ğŸª Extraer cookies
      env:
        GOOGLE_SHEETS_ID: ${{ secrets.GOOGLE_SHEETS_ID }}
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        DEBUG_MODE: ${{ github.event.inputs.debug_mode }}
      run: |
        if [ "$DEBUG_MODE" = "true" ]; then
          echo "ğŸ› Ejecutando en modo debug..."
          npm run extract 2>&1 | tee extraction-log.txt
        else
          echo "ğŸš€ Ejecutando extracciÃ³n normal..."
          npm run extract
        fi

    - name: ğŸ“Š Mostrar resumen
      if: always()
      run: |
        echo "ğŸ“ˆ Resumen de ejecuciÃ³n:"
        echo "- Fecha: $(date)"
        echo "- Estado: ${{ job.status }}"

    - name: ğŸ“¤ Subir logs de debug
      if: failure() && github.event.inputs.debug_mode == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs-${{ github.run_number }}
        path: |
          extraction-log.txt
          *.png
          *.html
        retention-days: 7

    - name: ğŸš¨ Notificar si fallÃ³
      if: failure()
      run: |
        echo "âŒ La extracciÃ³n fallÃ³"
        echo "ğŸ”§ Recomendaciones:"
        echo "  1. Ejecutar manualmente con debug activado"
        echo "  2. Revisar logs en los artifacts"
        echo "  3. Verificar si la pÃ¡gina de Univalle cambiÃ³" 